---
title: "Nowcasting GDP growth in Austria via the construction of a daily economic sentiment index using Google Trends"
subtitle: "Masterthesis"
author: "Anne Valder"
date: "2/12/2022"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r}
rm(list=ls())
getwd()
```

# Load packages 

```{r, include=FALSE}
library(readr)
library(readxl)
library(dplyr)
library(tidyverse)
library(ggplot2)
library(tseries)
library(forecast)
library(vars)
library(GGally)
library(Metrics)
library(caret)
library(collapse)
library(urca)
library(tsbox)
library(lubridate)
library(dygraphs)
#library(macror) # for latex table adf 
library(xtable) # latex table 
library(midasr) # Mixed data sampling models
```

# Load all data (GDP, CCI, Goolge)
```{r}
# set uo Data Matrix
t_0 <- as.Date("2006-01-01") #Setting start date for the series
t_1 <- as.Date("2021-07-01") #Setting end date for the series
t_2 <- as.Date("2021-12-31")
Date_q <- seq.Date(t_0,t_1,by="quarter")
Date_m <- seq.Date(t_0,t_2,by="month")

bigT <- length(Date_q)
M <- 6
Data   <- matrix(NA,bigT,M)
colnames(Data)  <- c("gdp", "cci", "google","gdp_ts", "cci_ts", "google_ts") 
Data <- as.data.frame(Data)
rownames(Data)  <- as.Date(Date_q)
```

### GDP
```{r}
# accessed last 11.02.2022
#Source: https://data.oecd.org/gdp/quarterly-gdp.htm#indicator-chart
gdp <- read.csv("https://raw.githubusercontent.com/anneval/MA_data/main/RData/GDP_oecd.csv")[9:71,6:7]

colnames(gdp)[colnames(gdp) %in% c("TIME", "Value")] <- c("QDate", "value")
gdp <- cbind(gdp,Date_q)
#ts:
gdp_ts <- ts(gdp$value, start=c(2006,1), end = c(2021,3), frequency = 4)

Data[(Date_q%in%gdp$Date_q),1] <- gdp$value
Data$gdp_ts <- ts(Data$gdp, start=c(2006,1), end = c(2021,3), frequency = 4)
```

### CCI
```{r, include=FALSE}
# accessed last 11.02.2022
#Source: https://ec.europa.eu/info/business-economy-euro/indicators-statistics/economic-databases/business-and-consumer-surveys/download-business-and-consumer-survey-data/time-series_en#consumers

cci <- read.csv2("https://raw.githubusercontent.com/anneval/MA_data/main/RData/CCI.csv")[253:444,c(1,297)]

colnames(cci)[colnames(cci) %in% c("X", "CONS.AT.TOT.COF.BS.M")] <- c("time", "value")
cci <- cbind(cci,Date_m)
cci <- arrange(cci, Date_m)
cci$Date_q <- as.yearqtr(cci$Date_m) 
cci$Date_q <- as.Date(cci$Date_q)

cci_qtrly <- cci %>% group_by(Date_q) %>%
  summarise_all(mean)

cci_qtrly_63 <- cci_qtrly[1:63,]
Data[(Date_q%in%cci_qtrly_63$Date_q),2] <- (cci_qtrly_63$value)
Data$cci_ts <- ts(Data$cci, start=c(2006,1), end = c(2021,3), frequency = 4)
```

### Google
```{r}
#series gets updated daily via Github workflow
Google_AT_daily <- read.csv("https://raw.githubusercontent.com/anneval/MA_data/main/raw/at/trendecon_sa.csv")

# transform to quarterly
Google_AT_daily$time <- as.Date(Google_AT_daily$time)
Google_AT_daily <- arrange(Google_AT_daily, time)
Google_AT_daily$Date_q <- as.yearqtr(Google_AT_daily$time)
Google_AT_daily$Date_q <- as.Date(Google_AT_daily$Date_q)

Google_AT_qtrly <- Google_AT_daily %>% group_by(Date_q) %>%
  summarise_all(mean)

Google_AT_qtrly_63 <- Google_AT_qtrly[1:63,]
Data[(Date_q%in%Google_AT_qtrly_63$Date_q),3] <- (Google_AT_qtrly_63$value)
Data$google_ts <- ts(Data$google, start=c(2006,1), end = c(2021,3), frequency = 4)
```

# Graphics
```{r}
par(mfrow = c(3,1))

Sys.setlocale("LC_TIME", "C") # forenglish names

# GDP
ggplot(gdp, aes(x=Date_q, y=value,col = variable)) +
  geom_line(color = "steelblue") +
  theme_light() +
  labs(x = "Time", y = "Austria's GDP growth (in%)")+
  theme(plot.title = element_text(hjust = 0.5, face ="bold")) +
  scale_x_date(date_labels="%b %y",date_breaks  ="24 month")
  
#CCI

ggplot(cci, aes(x=Date_m, y=value)) +
  geom_line(color = "steelblue") +
  theme_light() +
    labs( x = "Time", y = "Austria's Consumer Confidence (total)")+
  theme(plot.title = element_text(hjust = 0.5, face ="bold")) +
  scale_x_date(date_labels="%b %y",date_breaks  ="24 month")

# DESI - Google

ggplot(Google_AT_daily, aes(x=time, y=value)) +
  geom_line(color = "black") +
  theme_light() +
    labs( x = "Time", y = "Austria's Google DESI")+
  theme(plot.title = element_text(hjust = 0.5, face ="bold")) +
  scale_x_date(date_labels="%b %y",date_breaks  ="24 month")
```



# Comparison all data sources
```{r}
##### Abilene fÃ¼r comparison abbilden 
ts.plot(ts(Data[,1],frequency = 4, start = c(2006,1)),
          ts(Data[,3],frequency = 4, start = c(2006,1)),
          ts(cci_qtrly$value,frequency = 4, start = c(2006,1)),
    col = c("red", "blue","black"),
    xlab = "Year", 
    ylab = "GDP growth", 
    lwd = 1)
legend("bottomright", c("GDP growth", "DESI","CCI"), col=c("red","blue", "black"), lty=c(1),
       inset=c(0,1), xpd=TRUE, horiz=TRUE, bty="n"
       )
```
# Comparison with CH and DE DESI

```{r}
Google_DE_daily <- read.csv("https://raw.githubusercontent.com/trendecon/data/master/data/de/trendecon_sa.csv")
Google_CH_daily <- read.csv("https://raw.githubusercontent.com/trendecon/data/master/data/ch/trendecon_sa.csv")

Google_DE_daily$time <- as.Date(Google_AT_daily$time)
Google_CH_daily$time <- as.Date(Google_AT_daily$time)

df <- cbind(Google_AT_daily$value,Google_DE_daily$value,Google_CH_daily$value)
colnames(df) <- c("AT","DE","CH")
cor_df <- cor(df)

stargazer::stargazer(cor_df, title = "Correlation 3 different samples")


google <- Google_AT_daily[,1:2]
Google_AT_month <- ts_frequency(google, to = "month") %>% ts_xts() 
Google_DE_month <- ts_frequency(Google_DE_daily, to = "month") %>% ts_xts() 
Google_CH_month <- ts_frequency(Google_CH_daily, to = "month") %>% ts_xts() 

op <- options(
  tsbox.lwd = 1,
  tsbox.col = c("red","blue", "black")
)

tsbox::ts_plot("DESI Austria" = Google_AT_month,"DESI Switzerland" = Google_CH_month,"DESI Germany" = Google_DE_month,ylab="Google DESI")
    options(op)            
               
              
```



# Dataframes for later models:
```{r}
Data_Var <- Data[,1:3]
Data$gdp_lag <- lag(Data$gdp)

Data_train <- Data[1:44,] # 70%
Data_test <- Data[45:63,] #30%
```

# Correlations:
```{r}
ggpairs(Data[,1:3])
```

# Stationarity: ADF tests 
```{r}
adfgdp <- adf.test(Data$gdp) # stationary
adfcci <- adf.test(Data$cci) # stationary
adfgoogle <- adf.test(Data$google) #stationary

adfgdp
adfcci
adfgoogle

adf.test(diff(Data$gdp))
adf.test(diff(Data$cci))
adf.test(diff(Data$google))
```

#Kpss tests and phillip peron tests:
```{r}
kpss.test(Data$gdp) # stationary
kpss.test(Data$cci) #  stationary at 5%
kpss.test(Data$google) # stationary

pp.test(Data$gdp) # stationary
pp.test(Data$cci) # not stationary (0.21)
pp.test(Data$google) # stationary
```

### Summary for Latex document
```{r,message=FALSE, warning=FALSE}
x<-urTable(Data[,1:3], tests = c("adf", "pp", "kpss"), order = 1, file = NULL,
format="latex")
print(xtable(x, type = "latex"), file = "stattests.tex")
```

# ACF and PACF plots: Reasoning stationarity
```{r}
par(mfrow = c(3,1))
acf(Data$gdp)
acf(Data$cci)
acf(Data$google)

par(mfrow = c(3,1))
pacf(Data$gdp)
pacf(Data$cci)
pacf(Data$google)
```

# Expanding Window estimation

### Formula:
```{r}
#Expanding window estimation instead of fixed test and train data set (advantage: average over all). An expanding window works like this: Use the past 100 days worth of data to estimate a regression model.Use the regression model to predict the stock price 1 day from now. Use all of the observations including the predicted value for tomorrow (i.e. observations 1 through 101) to run a regression model. Use this to predict the stock price 2 days from now. Use all of the observations including the predicted values to run a regression model. Use this to predict the stock price 3 days from now.Repeat this until you have as many observations as you want to predict

expanding_window_OLS <- function(data, dep_var, start = 19){ 
  expanding_OLS <- list() # empty vector
  predicted_OLS <- list()
  resid_OLS <- list()
  error_OLS <- c() 
  i <- 0
  for(t in start:nrow(data)){ # from 19 bis 63
    i <- i+1 # first one is i=1 
    expanding_OLS[[i]] <- lm(formula = model, data = data[1:(t-1),]) # first train is 1:18
    resid_OLS[[i]] <- resid(expanding_OLS[[i]])
    predicted_OLS[i] <- predict(expanding_OLS, newdata = data[t,])
    error_OLS[i] <- as.numeric(predicted_OLS[[i]]- data[t,1]) # against original GDP growth 
    Summary_OLS <- list(expanding_OLS,predicted_OLS, resid_OLS,error_OLS)
  }
  return(Summary_OLS)
}
```

### Model 1 Expanding window:

```{r, message=FALSE, warning=FALSE}
dep_var <- "gdp"
model = gdp ~ gdp_lag

expanding_OLS1 <- expanding_window_OLS(Data[2:63,], dep_var, start = 19)

#predictions
pred1 <- do.call(rbind.data.frame, expanding_OLS1[[2]]) # NAs wegen lag! 
Date_q_pred <- Date_q[20:63]
colnames(pred1) <- c("value")

pred1 <- as.ts(pred1, start=c(2010,4), end = c(2021,3), frequency = 4)

# Out of Sample error terms----------------------------------------------------------------
error_OLS1 <- expanding_OLS1[[4]]
error_OLS1 <-error_OLS1[!is.na(error_OLS1)]
MAE_OLS_OOS1 <- mean(abs(error_OLS1))
MAE_OLS_OOS1
RMSE_OLS_OOS1  <- sqrt(mean(error_OLS1^2)) 
RMSE_OLS_OOS1
MSE_OLS1 <- mean(error_OLS1^2) 
MSE_OLS1
# IS error terms----------------------------------------------------------------
# IS: If you are forecasting for an observation that was part of the data sample - it is in-sample forecast.
resid_OLS1 <- expanding_OLS1[[3]]
final_resid_OLS1 <- resid_OLS1[[length(resid_OLS1)]]

RMSE_OLS_IS1    <- sqrt(mean(final_resid_OLS1^2))
RMSE_OLS_IS1

# Autocorrelation residuals:
checkresiduals(final_resid_OLS1)
```

#### Plot Model 1 against GDP growth
```{r}
plotexp_1 <- ts.plot(ts(Data[20:63,1],frequency = 4, start = c(2010,4),end = c(2021,3)),
          ts(pred1,frequency = 4, start = c(2010,4),end = c(2021,3)),
    col = c("black", "red"),
    xlab = "Year", 
    ylab = "GDP growth (%)", 
    lwd = 1)
legend("bottomleft", c("GDP growth", "AR(1)"), col=c("black","red"), lty=c(1),
        xpd=TRUE, bty="b", cex=0.75
      )
```

### Model 2 Expanding window
```{r, message=FALSE, warning=FALSE}
model = gdp ~ cci
expanding_OLS2 <- expanding_window_OLS(Data, dep_var, start = 19)

pred2 <- do.call(rbind.data.frame, expanding_OLS2[[2]]) 
colnames(pred2) <- c("value")
Date_q_pred <- Date_q[19:63]

pred2 <- as.ts(pred2, start=c(2010,3), end = c(2021,3), frequency = 4)

# Out of Sample error terms----------------------------------------------------------------
error_OLS2 <- expanding_OLS2[[4]]
error_OLS2 <-error_OLS2[!is.na(error_OLS2)]
MAE_OLS_OOS2 <- mean(abs(error_OLS2))
MAE_OLS_OOS2
RMSE_OLS_OOS2   <- sqrt(mean(error_OLS2^2)) 
RMSE_OLS_OOS2
MSE_OLS2 <- mean(error_OLS2^2) 
MSE_OLS2

# IS error terms----------------------------------------------------------------
# IS: If you are forecasting for an observation that was part of the data sample - it is in-sample forecast.
resid_OLS2 <- expanding_OLS2[[3]]
final_resid_OLS2 <- resid_OLS2[[length(resid_OLS2)]]

RMSE_OLS_IS2   <- sqrt(mean(final_resid_OLS2^2))
RMSE_OLS_IS2

# Autocorrelation residuals:
checkresiduals(final_resid_OLS2)

```

#### Plot Model 2 against GDP growth
```{r, message=FALSE, warning=FALSE}
plotexp_2 <- ts.plot(ts(Data[19:63,1],frequency = 4, start = c(2010,3)),
          ts(pred2,frequency = 4, start = c(2010,3)),
    col = c("black", "red"),
    xlab = "Year", 
    ylab = "GDP growth (%)", 
    lwd = 1)
legend("bottomleft", c("GDP growth", "CCI"), col=c("black","red"), lty=c(1),
        xpd=TRUE, bty="b", cex=0.75
      )
```

### Model 3 Expanding window
```{r, message=FALSE, warning=FALSE}
model = gdp ~ google
expanding_OLS3 <- expanding_window_OLS(Data, dep_var, start = 19)

pred3 <- do.call(rbind.data.frame, expanding_OLS3[[2]]) 
pred3
colnames(pred3) <- c("value")
Date_q_pred <- Date_q[19:63]
pred3 <- as.ts(pred3, start=c(2010,3), end = c(2021,3), frequency = 4)

# Out of Sample error terms----------------------------------------------------------------
error_OLS3 <- expanding_OLS3[[4]]
error_OLS3 <-error_OLS3[!is.na(error_OLS3)]
MAE_OLS_OOS3 <- mean(abs(error_OLS3))
MAE_OLS_OOS3
RMSE_OLS_OOS3 <- sqrt(mean(error_OLS3^2)) 
RMSE_OLS_OOS3
MSE_OLS3 <- mean(error_OLS3^2) 
MSE_OLS3

# IS error terms----------------------------------------------------------------
# IS: If you are forecasting for an observation that was part of the data sample - it is in-sample forecast.

resid_OLS3 <- expanding_OLS3[[3]]
final_resid_OLS3 <- resid_OLS3[[length(resid_OLS3)]]

RMSE_OLS_IS3    <- sqrt(mean(final_resid_OLS3^2))
RMSE_OLS_IS3

# Autocorrelation residuals:
checkresiduals(final_resid_OLS3)


```

#### Plot Model 3 against GDP growth
```{r}
plotexp_3 <- ts.plot(ts(Data[19:63,1],frequency = 4, start = c(2010,3)),
          ts(pred3,frequency = 4, start = c(2010,3)),
    col = c("black", "red"),
    xlab = "Year", 
    ylab = "GDP growth (%)", 
    lwd = 1)
legend("bottomleft", c("GDP growth", "DESI"), col=c("black","red"), lty=c(1),
        xpd=TRUE, bty="b", cex=0.75
      )
```

### Model 4 Expanding window
```{r, message=FALSE, warning=FALSE}
model = gdp ~ gdp_lag + cci
  expanding_OLS4 <- expanding_window_OLS(Data[2:63,], dep_var, start = 19)

#predictions
pred4 <- do.call(rbind.data.frame, expanding_OLS4[[2]]) # NAS wegen lag! 
Date_q_pred <- Date_q[20:63]
colnames(pred4) <- c("value")
pred4 <- as.ts(pred4, start=c(2010,4), end = c(2021,3), frequency = 4)

# Out of Sample error terms----------------------------------------------------------------
error_OLS4 <- expanding_OLS4[[4]]
error_OLS4 <-error_OLS4[!is.na(error_OLS4)]
MAE_OLS_OOS4 <- mean(abs(error_OLS4))
MAE_OLS_OOS4
RMSE_OLS_OOS4  <- sqrt(mean(error_OLS4^2)) 
RMSE_OLS_OOS4
MSE_OLS4 <- mean(error_OLS4^2) 
MSE_OLS4

# IS error terms----------------------------------------------------------------
# IS: If you are forecasting for an observation that was part of the data sample - it is in-sample forecast.
resid_OLS4 <- expanding_OLS4[[3]]
final_resid_OLS4 <- resid_OLS4[[length(resid_OLS4)]]
RMSE_OLS_IS4   <- sqrt(mean(final_resid_OLS4^2))
RMSE_OLS_IS4

# Autocorrelation residuals:
checkresiduals(final_resid_OLS4)
```
### Model 5 Expanding window
```{r, message=FALSE, warning=FALSE}
model = gdp ~ gdp_lag + google
expanding_OLS5 <- expanding_window_OLS(Data[2:63,], dep_var, start = 19)

#predictions
pred5 <- do.call(rbind.data.frame, expanding_OLS5[[2]]) # NAS wegen lag! 
colnames(pred5) <- c("value")
Date_q_pred <- Date_q[20:63]
pred5 <- as.ts(pred5, start=c(2010,4), end = c(2021,3), frequency = 4)

# Out of Sample error terms----------------------------------------------------------------
error_OLS5 <- expanding_OLS5[[4]]
error_OLS5 <-error_OLS5[!is.na(error_OLS5)]
MAE_OLS_OOS5 <- mean(abs(error_OLS5))
MAE_OLS_OOS5
RMSE_OLS_OOS5  <- sqrt(mean(error_OLS5^2)) 
RMSE_OLS_OOS5
MSE_OLS5 <- mean(error_OLS5^2) 
MSE_OLS5
# IS error terms----------------------------------------------------------------
# IS: If you are forecasting for an observation that was part of the data sample - it is in-sample forecast.
resid_OLS5 <- expanding_OLS5[[3]]
final_resid_OLS5 <- resid_OLS5[[length(resid_OLS5)]]

RMSE_OLS_IS5    <- sqrt(mean(final_resid_OLS5^2))
RMSE_OLS_IS5

# Autocorrelation residuals:
checkresiduals(final_resid_OLS5)
```

#### Plot Model 4&5 against GDP growth
```{r}
plotexp_5 <- ts.plot(ts(Data[20:63,1],frequency = 4, start = c(2010,4)),
          ts(pred4,frequency = 4, start = c(2010,4)),
          ts(pred5,frequency = 4, start = c(2010,4)),
    col = c("black", "red","blue"),
    xlab = "Year", 
   ylab = "GDP growth (%)", 
    lwd = 1)
legend("bottomleft", c("GDP growth","CCI & AR(1)" ,"DESI & AR(1)"), col=c("black","red","blue"), lty=c(1), xpd=TRUE, bty="b",cex=0.75
       )
```

### Model 6 Expanding window
```{r, message=FALSE, warning=FALSE}
model = gdp ~ gdp_lag + cci + google
expanding_OLS6 <- expanding_window_OLS(Data[2:63,], dep_var, start = 19)

#predictions
pred6 <- do.call(rbind.data.frame, expanding_OLS6[[2]]) # NAS wegen lag! 
colnames(pred6) <- c("value")
Date_q_pred <- Date_q[20:63]
pred6 <- as.ts(pred6, start=c(2010,4), end = c(2021,3), frequency = 4)

# Out of Sample error terms----------------------------------------------------------------
error_OLS6 <- expanding_OLS6[[4]]
error_OLS6 <-error_OLS6[!is.na(error_OLS6)]
MAE_OLS_OOS6 <- mean(abs(error_OLS6))
MAE_OLS_OOS6
RMSE_OLS_OOS6  <- sqrt(mean(error_OLS6^2)) 
RMSE_OLS_OOS6
MSE_OLS6 <- mean(error_OLS6^2) 
MSE_OLS6

# IS error terms----------------------------------------------------------------
# IS: If you are forecasting for an observation that was part of the data sample - it is in-sample forecast.
resid_OLS6 <- expanding_OLS6[[3]]
final_resid_OLS6 <- resid_OLS6[[length(resid_OLS6)]]

RMSE_OLS_IS6    <- sqrt(mean(final_resid_OLS6^2))
RMSE_OLS_IS6
# Autocorrelation residuals:
checkresiduals(final_resid_OLS6)
```

### Model 7 Expanding window
```{r, warning=F, message=FALSE}
model = gdp ~ cci + google
expanding_OLS7 <- expanding_window_OLS(Data, dep_var, start = 19)

#predictions
pred7 <- do.call(rbind.data.frame, expanding_OLS7[[2]]) # NAS wegen lag! 
colnames(pred7) <- c("value")
Date_q_pred <- Date_q[19:63]
pred7 <- as.ts(pred7, start=c(2010,3), end = c(2021,3), frequency = 4)

# Out of Sample error terms----------------------------------------------------------------
error_OLS7 <- expanding_OLS7[[4]]
error_OLS7 <-error_OLS7[!is.na(error_OLS7)]
MAE_OLS_OOS7 <- mean(abs(error_OLS7))
MAE_OLS_OOS7
RMSE_OLS_OOS7  <- sqrt(mean(error_OLS7^2)) 
RMSE_OLS_OOS7
MSE_OLS7 <- mean(error_OLS7^2) 
MSE_OLS7
# IS error terms----------------------------------------------------------------
# IS: If you are forecasting for an observation that was part of the data sample - it is in-sample forecast.
resid_OLS7 <- expanding_OLS7[[3]]
final_resid_OLS7 <- resid_OLS7[[length(resid_OLS7)]]

RMSE_OLS_IS7    <- sqrt(mean(final_resid_OLS7^2))
RMSE_OLS_IS7
# Autocorrelation residuals:
checkresiduals(final_resid_OLS7)
```

#### Plot Model 6&7 against GDP growth
```{r}
plotexp_7 <- ts.plot(ts(Data[20:63,1],frequency = 4, start = c(2010,3)),
          ts(pred6,frequency = 4, start = c(2010,3)),
          ts(pred7[2:45,],frequency = 4, start = c(2010,3)),
    col = c("black", "red","blue"),
    xlab = "Year", 
    ylab = "GDP growth (%)", 
    lwd = 1)
legend("bottomleft", c("GDP growth","AR(1) & CCI & DESI", "CCI & DESI"), col=c("black","red","blue"), lty=c(1), xpd=TRUE, bty="b",cex=0.75
       )
```

#### Results expanding window for Latex document
```{r}
comparison_MAE_OOS <- rbind("MAE_OLS_OOS" = MAE_OLS_OOS1,MAE_OLS_OOS2,MAE_OLS_OOS3,MAE_OLS_OOS4,MAE_OLS_OOS5,MAE_OLS_OOS6,MAE_OLS_OOS7)

comparison_RMSE_OOS <- rbind("RMSE_OLS_OOS" = RMSE_OLS_OOS1,RMSE_OLS_OOS2,RMSE_OLS_OOS3,RMSE_OLS_OOS4,RMSE_OLS_OOS5,RMSE_OLS_OOS6,RMSE_OLS_OOS7)

comparison_RMSE_IS <- rbind("RMSE_OLS_IS" = RMSE_OLS_IS1,RMSE_OLS_IS2,RMSE_OLS_IS3,RMSE_OLS_IS4,RMSE_OLS_IS5,RMSE_OLS_IS6,RMSE_OLS_IS7)

 
comparison_OOS <- data.frame(     "RMSE_OOS" = comparison_RMSE_OOS, 
                                  "RMSE_IS" = comparison_RMSE_IS,
                                  "MAE_OOS" = comparison_MAE_OOS)

stargazer::stargazer(comparison_OOS,summary=FALSE)

print(xtable::xtable(comparison_OOS, label = "tab:acc", caption = "3-month ahead rolling in-sample forecast. Displayed here are several accuracy measures for the PES forecasting model."),  include.rownames = FALSE, type="html")
```

# VAR MODEL
### Manual VAR select
####constant:
```{r}
var.AIC <- VAR(Data[,1:3],  type="none" , lag.max = 2, ic = c("AIC"))
var.AIC.c <- VAR(Data[,1:3],  type="const" , lag.max = 2, ic = c("AIC")) ## lag 2

AIC.woc <- cbind(AIC(var.AIC), BIC(var.AIC)) 
AIC.wc<- cbind(AIC(var.AIC.c), BIC(var.AIC.c)) 

MChoice_table <- rbind(AIC.woc, AIC.wc)
MChoice_table.names <- rbind("using AIC without constant", "using AIC with constant"
                        )  
rownames(MChoice_table)<- MChoice_table.names
colnames(MChoice_table) <- cbind("AIC", "BIC")

print(xtable::xtable(MChoice_table,caption="Model Choice Results",label="tab:mc"),
      sanitize.text.function=function(UR.table){UR.table},comment=FALSE)
```

### VAR model Varselect (GDP,PES,CCI) - best expanding model

```{r}
fit_VAR1 <- VARselect(Data[,1:3],type = "const")   
lag_VAR1 <- fit_VAR1$selection[1]  
#lag_VAR1 

VAR1_est <- vars::VAR(y = Data[,1:3], p = lag_VAR1,type = "const")
summary(VAR1_est$varresult$gdp)
acc_is_VAR1 <- forecast::accuracy(VAR1_est$varresult$gdp) # IS accuracy
stargazer::stargazer(acc_is_VAR1)

forecast_VAR1<- predict(VAR1_est,n.ahead =3)  
forecast_VAR1

df_fcst <- as.data.frame(forecast_VAR1$fcst$google)
stargazer::stargazer(df_fcst,summary = FALSE)
###### OOS accuracy
acc_oos_VAR1 <-forecast::accuracy(Data$gdp,forecast_VAR1$fcst$gdp) 
plot(forecast_VAR1)
stargazer::stargazer(acc_oos_VAR1)

```

#### Residual analysis
```{r}
resid_VAR1 <- data.frame(
  VAR1_est$varresult$gdp$residuals,
  VAR1_est$varresult$cci$residuals,
  VAR1_est$varresult$google$residuals)

adf.test(VAR1_est$varresult$gdp$residuals) # stationary
adf.test(VAR1_est$varresult$cci$residuals) #stationary
adf.test(VAR1_est$varresult$google$residuals)#stationary

Box.test(resid_VAR1$VAR1_est.varresult.gdp.residuals, type="Ljung-Box") # cannot reject H0

```

#### Normality test
```{r}
Normtest_VAR1 <- normality.test(VAR1_est) # H0: normality
print(Normtest_VAR1)
plot(Normtest_VAR1)
```

#### Autocorrelation residuals 
```{r}
# Better tests than durbinWatsonTest, not used! 
library(car)
durbinWatsonTest(VAR1_est$varresult$gdp)  # Small p-value of < 2.2e-16 indicates there is significant autocorrelation remaining in the residuals
```

#### serial correlation check
```{r}
#Portmanteau
ser.test_VAR1_PT <- serial.test(VAR1_est,type="PT.adjusted") # H0: no serial correlation, here cannot reject H0 of no correlation
ser.test_VAR1_PT  # here the null of no autocorrelation cannot be rejected, so no autocorrelation!
plot(ser.test_VAR1_PT, names = "GDP")
stargazer::stargazer(ser.test_VAR1_PT)

#breusch_godfrey
ser.test_VAR_BG <- serial.test(VAR1_est,type="BG") # H0: There is no autocorrelation at any order less than or equal to p.
ser.test_VAR_BG # here the null of no autocorrelation cannot be rejected, so no autocorrelation!
plot(ser.test_VAR_BG, names = "GDP")

#ARCH-LM test 
archtestVAR1 <- arch.test(VAR1_est) #cannot reject the H0 that the squared residuals are a sequence of white noise, namely, the residuals are homoscedastic. 
plot(archtestVAR1)
checkresiduals(VAR1_est$varresult$gdp)
```
#### Test for structural breaks
```{r}

VAR_Est_CUSUM <- stability(VAR1_est, type = "OLS-CUSUM")
VAR_Est_CUSUM
plot(VAR_Est_CUSUM)
```
#### Summary Results Model diagnostics for Latex document

```{r}
MDiagnostics_table <- cbind(ser.test_VAR1_PT$serial,ser.test_VAR_BG$serial,archtestVAR1$arch.mul,Normtest_VAR1$jb.mul$JB)[1:4,]

MDiagnostics_table.names <- rbind("Chi-squared
","df","p-values", "method"
                        )  
rownames(MDiagnostics_table)<- MDiagnostics_table.names
colnames(MDiagnostics_table) <- cbind("Portmanteau", "Breusch-Godfrey LM","JB-Test", "ARCH-LM")

print(xtable::xtable(MDiagnostics_table,caption="Model diagnostics results",label="Modeldiagnostics"),
      sanitize.text.function=function(UR.table){UR.table},comment=FALSE)
```

#### VAR(2, GDP,PES, CCI) expanding window 

```{r, warning=FALSE,message=FALSE}
# create new dataset with lags first: 
Data_Var <-flag(Data[1:3], 1:2)
Data_Var <- cbind(Data[,1:3],Data_Var)

model= gdp ~ L1.gdp +L2.gdp + L1.cci +L2.cci +L1.google + L2.google

expanding_VAR2 <- expanding_window_OLS(Data_Var[3:63,], dep_var, start = 19) 
#predictions
pred_VAR2 <- do.call(rbind.data.frame, expanding_VAR2[[2]])  
colnames(pred_VAR2) <- c("value")
Date_q_pred <- Date_q[13:63]

pred_VAR2 <- as.ts(pred_VAR2, start=c(2009,3), end = c(2021,3), frequency = 4)

### error in and OOS 
error_VAR2 <- expanding_VAR2[[4]]
error_VAR2 <-error_VAR2[!is.na(error_VAR2)]
MAE_VAR2_OOS <- mean(abs(error_VAR2))
MAE_VAR2_OOS
RMSE_VAR2_OOS  <- sqrt(mean(error_VAR2^2)) 
RMSE_VAR2_OOS
MSE_VAR2 <- mean(error_VAR2^2) 
MSE_VAR2
# IS error terms----------------------------------------------------------------
# IS: If you are forecasting for an observation that was part of the data sample - it is in-sample forecast.
resid_VAR2 <- expanding_VAR2[[3]]
final_resid_VAR2 <- resid_VAR2[[length(resid_VAR2)]]

RMSE_VAR2_IS    <- sqrt(mean(final_resid_VAR2^2))
RMSE_VAR2_IS
```

### Summary expanding VAR for Latex document

```{r}

comparison_errors <- data.frame(     "RMSE_OOS" = RMSE_VAR2_OOS, 
                                  "RMSE_IS" = RMSE_VAR2_IS,
                                  "MAE_OOS" = MAE_VAR2_OOS)

stargazer::stargazer(comparison_errors,summary=FALSE)
```

# ROBUSTNESS

## Standard OLS (train and test set)

### Model 1: $GDP_t = \beta_0 +\beta_1 GDP_{t-1} + \epsilon_t  \qquad  t =1,\dotsc,T$

```{r}
mod1 <- lm(gdp ~ lag(gdp), data = Data_train)
summary(mod1)
acc_is1 <-forecast::accuracy(mod1)

pred_mod1 <- predict(mod1, Data_test)
pred_mod1
acc_oos1 <-forecast::accuracy(Data_test$gdp,pred_mod1)
acc_oos1

forecast_mod1 <- predict(mod1, n.ahead = 3)
```
### Model 2:  $GDP_t = \beta_0 +\beta_1 CCI_{t} +\epsilon_t \qquad  t =1,\dotsc,T$
```{r}

mod2 <- lm(gdp ~ cci, data = Data_train)
summary(mod2)
sqrt(mean(mod2$residuals^2)) # IS 
acc_is2 <-forecast::accuracy(mod2)

pred_mod2 <- predict(mod2,Data_test)

acc_oos2 <-forecast::accuracy(Data_test$gdp,pred_mod2)
acc_oos2
```

### Model 3:  $GDP_t = \beta_0 +\beta_1 GT_{t,i} +\epsilon_t \qquad  t =1,\dotsc,T \qquad  n =1,\dotsc,N$

```{r}
Data_google <- Google_AT_qtrly[,c(1,3)]
colnames(Data_google) <- c("time", "google")

mod3<- lm(gdp ~ google, data = Data_train)
summary(mod3)
sqrt(mean(mod3$residuals^2)) # IS 
acc_is3 <- forecast::accuracy(mod3) # IS accuracy

pred_mod3 <- predict(mod3, Data_test)
pred_mod3

acc_oos3 <-forecast::accuracy(Data_test$gdp,pred_mod3)
acc_oos3

```
### Model 4: $GDP_t = \beta_0 +\beta_1 GDP_{t-1} + \beta_2 CCI_{t} + \epsilon_t \qquad  t =1,\dotsc,T$

```{r}
mod4<- lm(gdp ~ lag(gdp) + cci, data = Data_train)
summary(mod4)
sqrt(mean(mod4$residuals^2)) # IS 
acc_is4 <-forecast::accuracy(mod4) # IS accuracy

pred_mod4 <- predict(mod4, Data_test)
pred_mod4

acc_oos4 <-forecast::accuracy(Data_test$gdp,pred_mod4)
acc_oos4
```
### Model 5: $GDP_t = \beta_0 +\beta_1 GDP_{t-1} + \beta_2 GT_{t,i} + \epsilon_t \qquad  t =1$

```{r}
mod5<- lm(gdp ~ lag(gdp) + google, data = Data_train)
summary(mod5)
sqrt(mean(mod5$residuals^2)) # IS 
acc_is5 <- forecast::accuracy(mod5) # IS accuracy

pred_mod5 <- predict(mod5, Data_test)
acc_oos5 <-forecast::accuracy(Data_test$gdp,pred_mod5)
acc_oos5

```

### Model 6: $GDP_t = \beta_0 +\beta_1 GDP_{t-1} + \beta_2 CCI_{t} + \beta_3 GT_{t,i} + \epsilon_t \qquad  t =1,\dotsc,T$
```{r}
mod6<- lm(gdp ~ lag(gdp) + cci + google, data = Data_train)
summary(mod6)
sqrt(mean(mod6$residuals^2)) # IS 
acc_is6 <- forecast::accuracy(mod6) # IS 

##OOS
pred_mod6 <- predict(mod6, Data_test)
acc_oos6 <-forecast::accuracy(Data_test$gdp,pred_mod6)
acc_oos6

```
### Model 7: $GDP_t = \beta_0 + \beta_1 CCI_{t} + \beta_2 GT_{t,i} + \epsilon_t \qquad  t =1,\dotsc,T$

```{r}
mod7<- lm(gdp ~ cci + google, data = Data_train)
summary(mod7)
sqrt(mean(mod7$residuals^2)) # IS 
acc_is7 <- forecast::accuracy(mod7) # IS 

##OOS
pred_mod7 <- predict(mod7, Data_test)
acc_oos7 <-forecast::accuracy(Data_test$gdp,pred_mod7)
acc_oos7

#predictnew <- predict(mod6,)
```

### Summary results for Latex document

```{r}
stargazer::stargazer(mod1,mod2,mod3,mod4,mod5,mod6, mod7)

comparison_OLS_IS <- rbind("OLS_IS" = acc_is1,acc_is2,acc_is3,acc_is4,acc_is5,acc_is6,acc_is7)
comparison_OLS_OOS <- rbind("OLS_OOS" = acc_oos1,acc_oos2,acc_oos3,acc_oos4,acc_oos5,acc_oos6,acc_oos7)

stargazer::stargazer(comparison_OLS_IS, summary = FALSE,colnames = TRUE)
stargazer::stargazer(comparison_OLS_OOS, summary = FALSE,colnames = TRUE)

```

## Robustness Cross Validation instead of expanding window 

```{r}
ctrl <- trainControl(method = "LOOCV")

model1_CV <- train(gdp ~ gdp_lag, data = Data[2:63,], method = "lm", trControl = ctrl)
print(model1_CV)
stargazer::stargazer(model1_CV)

model2_CV <- train(gdp ~ cci, data = Data, method = "lm", trControl = ctrl)
print(model2_CV)

model3_CV <- train(gdp ~ google, data = Data, method = "lm", trControl = ctrl)
print(model3_CV)

model4_CV <- train(gdp ~ gdp_lag + cci, data = Data[2:63,], method = "lm", trControl = ctrl)
print(model4_CV)

model5_CV <- train(gdp ~ gdp_lag + google, data = Data[2:63,], method = "lm", trControl = ctrl)
print(model5_CV)

model6_CV <- train(gdp ~ gdp_lag + google + cci, data = Data[2:63,], method = "lm", trControl = ctrl)
print(model6_CV)

model7_CV <- train(gdp ~ google + cci, data = Data, method = "lm", trControl = ctrl)
print(model7_CV)

results <- rbind("LOOCV" = model7_CV$results,model6_CV$results,model5_CV$results,model4_CV$results,model3_CV$results,model2_CV$results,model1_CV$results)

```

### Summary Results LOOCV model for Latex document
```{r}
LOOCV_table <- rbind(model7_CV$results,model6_CV$results,model5_CV$results,model4_CV$results,model3_CV$results,model2_CV$results,model1_CV$results) 
                        
print(xtable::xtable(LOOCV_table,caption="LOOCV results",label="LOOCVresults"),
      sanitize.text.function=function(UR.table){UR.table},comment=FALSE)
```

## Robustness MIDAS
### MIDAS Model 1
```{r} 
gdp <- window(gdp_ts, end = c(2021, 3))
#Midas regression
midas1 <- midas_r(gdp ~ mls(gdp, 1, 1),start = NULL)

summary(midas1)
coef(midas1)
acc_is_m1<-forecast::accuracy(gdp,midas1$fitted.values)

```

### MIDAS Model 2 
```{r} 
cci_ts <- ts(cci$value, start=c(2006,1), end = c(2021,12), frequency = 12)
cci <- window(cci_ts, end = c(2021, 9))

#Midas regression
midas2 <- midas_r(gdp ~ mls(cci, 0, 3),start = NULL)

summary(midas2)
coef(midas2)

acc_is_m2<-forecast::accuracy(gdp,midas2$fitted.values)

#### forecasts:
fcst_cci <-window(cci_ts, start = c(2021,10),end = c(2021, 12))

fcst_cci <-as.data.frame(window(cci_ts, start = c(2021,10),end = c(2021, 12))) 
colnames(fcst_cci)  <- c("cci") 

fcst_midas2 <- midasr::forecast(midas2,newdata = fcst_cci, method = "static")
fcst_midas2
```

### MIDAS Model 3
```{r}
google_ts <-ts(Google_AT_daily$value[1:5844], start=c(2006,1), frequency = 365.25)
google <- window(google_ts, end = c(2021, 255))
google <- as.numeric(google)

y <- c(1:length(google))
datey <- (y-1)*3+1

test <-mlsd(google, 0, datey)

midas3 <- midas_r(gdp ~ mls(gdp, 1, 1) + mls(google, 0, 91),start = NULL)


summary(midas3)
coef(midas3)

acc_is_m3<-forecast::accuracy(gdp,midas3$fitted.values)

#### forecasts:

google_fcst <- as.data.frame(window(google_ts,start=c(2021, 256), end = c(2021, 347)))
colnames(google_fcst)  <- c("google") 
#1 quarter is 5752/62= 91.30159
fcst_midas3 <- midasr::forecast(midas3,newdata =google_fcst , method = "dynamic")
fcst_midas3
```

### MIDAS Model 4

```{r} 
#Midas regression
midas4 <- midas_r(gdp ~ mls(gdp, 1, 1) + mls(cci, 0, 3), 
              start = NULL)

summary(midas4)
coef(midas4)

acc_is_m4<-forecast::accuracy(gdp,midas4$fitted.values)

#### forecasts:

fcst_midas4 <- midasr::forecast(midas4,newdata = fcst_cci, method = "static")
fcst_midas4
```

### MIDAS Model 5

```{r} 
#Midas regression
midas5 <- midas_r(gdp ~ mls(gdp, 1, 1) + mls(google, 0, 91),start = NULL) 
summary(midas5)
coef(midas5)

acc_is_m5<-forecast::accuracy(gdp,midas5$fitted.values)

#### forecasts:
fcst_midas5 <- midasr::forecast(midas5,newdata = google_fcst, method = "static")
fcst_midas5
```

### MIDAS Model 6

```{r} 
#Midas regression
midas6 <- midas_r(gdp ~ mls(gdp, 1, 1) + mls(cci, 0, 3) + mls(google, 0, 91), 
              start = NULL)

summary(midas6)
coef(midas6)

acc_is_m6<-forecast::accuracy(gdp,midas6$fitted.values)

#### forecasts:
newdata <- list(fcst_cci,google_fcst)
fcst_midas6 <- midasr::forecast(midas6,newdata = newdata, method = "static")
fcst_midas6
```

### MIDAS Model 7

```{r} 
#Midas regression
midas7 <- midas_r(gdp ~ mls(cci, 0, 3) + mls(google, 0, 91), 
              start = NULL)

summary(midas7)
coef(midas7)

acc_is_m7<-forecast::accuracy(gdp,midas7$fitted.values)

#### forecasts:

fcst_midas7 <- midasr::forecast(midas7,newdata = newdata, method = "static")
fcst_midas7$mean

```

### Summary Results MIDAS

```{r}
MIDAS <- rbind(acc_is_m2,acc_is_m3,acc_is_m4,acc_is_m5,acc_is_m6,acc_is_m7)

rownames(MIDAS)  <- c("CCI", "DESI", "AR(1) & CCI","AR(1) & DESI", "AR(1) & CCI & DESI", "CCI & DESI") 

                        
print(xtable::xtable(MIDAS,caption="LOOCV results",label="LOOCVresults"),
      sanitize.text.function=function(UR.table){UR.table},comment=FALSE)
```

# Weekly indicators OeNB, WIFO and OECD
### Load data & prepare 
```{r}
google <- Google_AT_daily[,1:2]
library(tsbox)
google_w <- ts_frequency(google, to = "week") %>% ts_xts() ### Change from daily to weekly frequency

#### OECD weekly tracker
temp <- tempfile()
download.file("https://github.com/NicolasWoloszko/OECD-Weekly-Tracker/raw/main/Data/weekly_tracker.xlsx",
              destfile = temp)

oecd <- read_xlsx(temp, sheet = "Sheet1") %>%
  filter(region == "Austria") %>%
  mutate(date = as.Date(date),
         Tracker = `Tracker (yoy)` / 100) %>%
  filter(date >= "2020-01-01") %>%
  rename(time = date, value = Tracker) %>%
  dplyr::select(time, value) %>%
  ts_xts()

### OENB Weekly Tracker

temp <- tempfile()
download.file("https://www.oenb.at/dam/jcr:7c5ab44b-204d-4d45-a802-884d1019f7f5/data_on_the_weekly_GDP-indicator.csv",
              destfile = temp)

#### first weeks missing
wecon_oenb <- read_delim(temp, delim = ";", escape_double = FALSE, trim_ws = TRUE) %>%
  drop_na(Calenderweek) %>%
  rename(time = Calenderweek, value = `Real GDP compared to pre-crisis levels`) %>%
  dplyr::select(time, value)

wecon_oenb <- ts(wecon_oenb, start = c(2020,10), frequency = 52) %>% ts_xts()
wecon_oenb_test <- ts(wecon_oenb, 
   freq=365.25/7, 
   start=decimal_date(ymd("2020-03-06"))) %>% ts_xts()

wecon_oenb_test <- wecon_oenb_test %>% xts:::.drop.time()

### WIFO Weekly Tracker 
temp <- tempfile()
download.file("https://www.wifo.ac.at/wwadocs/konjunktur/W%C3%B6chentlicherWIFOWirtschaftsindex/WIFO-Konjunkturberichterstattung_W%C3%B6chentlicherWIFOWirtschaftsindex.xlsx",
              destfile = temp)

t0 <- as.numeric(as.Date("2007-01-01"))
t1 <- as.numeric(as.Date(Sys.Date()))
t <- round((t1 - t0) / 7) - 3 

wwwi <- read_xlsx(temp, sheet = "WWWI",
                  skip = 2, col_names = c("DATE", "VALUE", "cng_yearavg", "cng_quarter"),
                  n_max = t) %>%
  mutate(DATE = as.character(DATE)) %>%
  dplyr::select(DATE, VALUE) %>%
  rename(time = DATE, value = VALUE) %>%
  ts_xts()
```

### Adjust data & Plot
```{r}
google_w <- google_w[time(google_w) >= "2020-01-01"]  
wwwi <- wwwi[time(wwwi) >= "2020-01-01"]  
oecd <- oecd[time(oecd) >= "2020-01-01"]  

wecon_oenb <- wecon_oenb %>% xts:::.drop.time()

wwwi <- wwwi %>% ts_data.frame()
wwwi$time <- wwwi$time %m-% days(3)
wwwi <- wwwi %>% ts_xts()

oecd <- oecd %>% ts_data.frame()
oecd$time <- oecd$time %m-% days(2)
oecd <- oecd %>% ts_xts()

google_w <- google_w %>% ts_data.frame()
google_w$time <- google_w$time %m-% days(2)
google_w <- google_w %>% ts_xts()

wecon_oenb_test <- wecon_oenb_test %>% ts_data.frame()
wecon_oenb_test[1,1] <- as.Date("2020-03-06")
wecon_oenb_test <- wecon_oenb_test %>% ts_xts()

### Plot
ts_dygraphs(ts_c(
  `Google DESI` = google_w * 5,
  `WIFO WWWI` = wwwi,
  `OECD Weekly Tracker` = oecd * 100,
  `OENB Weekly Indicator` = wecon_oenb_test
))  %>%
  dySeries("Google DESI", strokeWidth=2, color = "black") %>%
  dySeries("WIFO WWWI", strokeWidth = 2,  color = "red") %>%
  dySeries("OECD Weekly Tracker", strokeWidth = 2,  color = "green") %>%
  dySeries("OENB Weekly Indicator", strokeWidth = 2,  color = "steelblue") %>%
  dyAxis("x", drawGrid = FALSE) %>%
  dyRangeSelector(dateWindow = c(as.Date("2020-01-01"), Sys.Date()))%>%
  dyOptions(useDataTimezone = TRUE)

```
#### Plot for Latx document
```{r}
month <- seq(as.Date("2020-01-01"), 
             as.Date("2022-03-01"), 
             by = "1 month")

month_numeric <- as.numeric(format(month, format = "%U"))
month_label <- format(month, format = "%b")
scale_x_continuous(breaks = month_numeric, 
                   labels = month_label)


ts.plot(ts(oecd*100,frequency = 52, start = c(2020,1)),
        ts(wwwi,frequency = 52, start = c(2020,1)),
        ts(google_w*5,frequency = 52, start = c(2020,1)),
        ts(wecon_oenb_test,frequency = 52, start = c(2020,10)),
        col = c("darkgreen", "red","black","steelblue"),
        xlab = "Time",
        main = "",
        lwd = 1
        )
legend("bottomright", c("OECD Weekly Tracker","WIFO WWWI", "Google DESI", "OENB Weekly Indicator"), col=c("darkgreen", "red","black","steelblue"), lty=c(1), xpd=TRUE, bty="b",cex=0.75
       )
```


# OLD!

### VAR with GDP AND PES - 2nd best expanding model 

```{r}
fit_VAR2 <- VARselect(Data[,c(1,3)],type = "const")   
lag_VAR2 <- fit_VAR2$selection[1]  
VAR2_est <- VAR(y = Data[,c(1,3)], p = lag_VAR2,type = "const")
summary(VAR2_est$varresult$gdp)
acc_is_VAR2 <-forecast::accuracy(VAR2_est$varresult$gdp) # IS accuracy

forecast_VAR2 <- predict(VAR2_est,n.ahead =3)  
forecast_VAR2
###### OOS accuracy?
acc_oos_VAR2 <-forecast::accuracy(Data$gdp,forecast_VAR2$fcst$gdp) 
plot(forecast_VAR2)
stargazer::stargazer(VAR2_est$varresult)
```

#### Residual analysis
```{r}
resid_VAR2 <- data.frame(
  VAR2_est$varresult$gdp$residuals,
  VAR2_est$varresult$google$residuals)

adf.test(VAR2_est$varresult$gdp$residuals)
adf.test(VAR2_est$varresult$google$residuals)
```

#### Normality test
```{r}
Normtest_VAR2 <- normality.test(VAR2_est) # H0: normality
print(Normtest_VAR2)
plot(Normtest_VAR2)
```
#### Serial correlation check
```{r}
ser.test_VAR2 <- serial.test(VAR2_est) # H0: no serial correlation
ser.test_VAR2
```

### VAR(2,GDP,PES) expanding window 

```{r, warning=FALSE,message=FALSE}
# create new datase
Data_Var <-flag(Data[c(1,3)], 1:2)
Data_Var <- cbind(Data[,c(1,3)],Data_Var)

model= gdp ~ L1.gdp +L2.gdp +L1.google + L2.google
expanding_VAR2 <- expanding_window_OLS(Data_Var[3:63,], dep_var, start = 19) 
#predictions
pred_VAR2 <- do.call(rbind.data.frame, expanding_VAR2[[2]])  
colnames(pred_VAR2) <- c("value")
rownames(pred_VAR2) <- Date_q_pred[3:51]
Date_q_pred <- Date_q[13:63]

pred_VAR2 <- as.ts(pred_VAR2, start=c(2010,4), end = c(2021,3), frequency = 4)
### error in and OOS 
error_VAR2 <- expanding_VAR2[[4]]
error_VAR2 <-error_VAR2[!is.na(error_VAR2)]
MAE_VAR2_OOS <- mean(abs(error_VAR2))
MAE_VAR2_OOS
RMSE_VAR2_OOS  <- sqrt(mean(error_VAR2^2)) 
RMSE_VAR2_OOS
MSE_VAR2 <- mean(error_VAR2^2) 
MSE_VAR2
# IS error terms----------------------------------------------------------------
# IS: If you are forecasting for an observation that was part of the data sample - it is in-sample forecast.
resid_VAR2 <- expanding_VAR2[[3]]
final_resid_VAR2 <- resid_VAR2[[length(resid_VAR2)]]

RMSE_VAR2_IS    <- sqrt(mean(final_resid_VAR2^2))
RMSE_VAR2_IS

```

#### VAR(2) manually test and train

```{r}
trainingdata <- ts(Data_train[,1:3], frequency = 4, start = c(2006, 1),end = c(2010,3))
testdata <- ts(Data_train[,1:3], frequency = 4, start = c(2010, 4),end = c(2021,3))

v <- VAR(trainingdata, p=2,type = "const") # change t0 2.!!!
summary(v$varresult$gdp)
p <- predict(v, n.ahead=3)

p$fcst$gdp

acc_is_VAR <-forecast::accuracy(trainingdata,v$varresult$gdp$fitted.values) 
acc_oos_VAR <-forecast::accuracy(testdata,p$fcst$gdp) 
```

#### OLD version expanding window

```{r message=FALSE, warning=FALSE, include=FALSE}
expanding_window_OLS <- function(data, dep_var, start = 19){ # change to 12 
  expanding_OLS <- list() # empty vector
  predicted_OLS <- list()
  resid_OLS <- list()
  error_OLS <- c() 
  i <- 0
  for(t in start:nrow(data)){#t in 13:51
    i <- i+1
    expanding_OLS[[i]] <- lm(formula = model, data = data[1:(t-1),]) # start at 13-1 so 12! 
    resid_OLS[[i]] <- resid(expanding_OLS[[i]])
    predicted_OLS[[i]] <- stats::predict(expanding_OLS[[i]],newdata = data[t,])#[t,])
    error_OLS[i]  <- as.numeric(predicted_OLS[[i]] - data[t,1]) # anpassen je nach dem welchs
    Summary_OLS <- list(expanding_OLS,predicted_OLS,resid_OLS,error_OLS)
  }
  return(Summary_OLS)
}
```

## ARIMA MODEL

### Auto Arima 
```{r}
fit <- auto.arima(Data[,"gdp"], trace = TRUE,  ic = c("aic")) #MA(1)
arima <- Arima(Data$gdp, model=fit)

stargazer::stargazer(arima)
summary(arima) # IS errors
acc_is_MA1 <- forecast::accuracy(arima)

adf.test(arima$residuals)
forecast_MA1 <-predict(arima,n.ahead = 3)
forecast_MA1_1 <-predict(arima)

ts.plot(arima$fitted)

acc_oos_MA1 <-forecast::accuracy(Data$gdp,forecast_MA1$pred) 
future = forecast(arima, h = 3)
plot(future)

checkresiduals(arima)
adf.test(arima$residuals)
```

#### Manually ARIMA  
```{r}
arma1 <- arima(Data$gdp, order = c(1,0,1))
ar2ma1 <- arima(Data$gdp, order = c(2,0,1))
ar1 <- arima(Data$gdp, order = c(1,0,0))
ar2 <- arima(Data$gdp, order = c(2,0,0))
ma1 <- arima(Data$gdp, order = c(0,0,1))

AIC <- AIC(arma1, ar2ma1, ar1, ar2,ma1)
BIC<- BIC(arma1, ar2ma1, ar1, ar2,ma1)
ab<- cbind(AIC, BIC)

stargazer::stargazer(ar1,ma1)
```

#### Extension since ARMA(1,1) seems best

```{r}
ARMA_11 <- Arima(Data$gdp, order = c(1,0,1))
summary(ARMA_11)
forecast::accuracy(ARMA_11)
adf.test(ARMA_11$residuals)
stargazer::stargazer(ARMA_11$var.coef)

forecast_ARMA1 <-predict(ARMA_11,n.ahead = 3)
forecast_ARMA1$pred

acc_oos_ARMA1 <-forecast::accuracy(Data$gdp,forecast_ARMA1$pred) 
future = forecast(ARMA_11, h = 3) # same results as predict and nahead but only this way plotting works!
plot(future)
checkresiduals(ARMA_11)
```

#### ARIMA(2,0,0) expanding estimation 

```{r}
Data$gdp_lag2 <- lag(Data$gdp_lag)

dep_var <- "gdp"
model = gdp ~ gdp_lag + gdp_lag2

expanding_AR2 <- expanding_window_OLS(Data[3:63,], dep_var, start = 13)

#predictions
pred_AR2 <- do.call(rbind.data.frame, expanding_AR2[[2]]) 
colnames(pred_AR2) <- c("value")
rownames(pred_AR2) <- Date_q_pred[3:51]
Date_q_pred <- Date_q[13:63]

pred_AR2 <- as.ts(pred, start=c(2009,3), end = c(2021,3), frequency = 4)
ts.plot(pred_AR2)

### error in and OOS 
error_AR2 <- expanding_AR2[[4]]
error_AR2 <-error_AR2[!is.na(error_AR2)]
MAE_OOS_AR2 <- mean(abs(error_AR2))
MAE_OOS_AR2
RMSE_OOS_AR2  <- sqrt(mean(error_AR2^2)) 
RMSE_OOS_AR2
MSE_AR2 <- mean(error_AR2^2) 
MSE_AR2
# IS error terms----------------------------------------------------------------
# IS: If you are forecasting for an observation that was part of the data sample - it is in-sample forecast.
resid_AR2 <- expanding_AR2[[3]]
final_resid_AR2 <- resid_AR2[[length(resid_AR2)]]

RMSE_AR2_IS    <- sqrt(mean(final_resid_AR2^2))
RMSE_AR2_IS
```

### MIDAS Model 3 OLD  
```{r}
## MORE CORRECT VERSION WITH mlsd function 91.30 days but forecast not possible..
google_ts <-ts(Google_AT_daily$value[1:5844], start=c(2006,1), frequency = 365.25)#31.12

google <- window(google_ts, end = c(2021, 274))
google <- as.numeric(google)

y <- c(1:length(google))
datey <- (y-1)*3+1
midas3 <- midas_r(gdp ~ mls(gdp, 1, 1) + mlsd(google, 0, datey),start = NULL)

summary(midas3)
coef(midas3)

acc_is_m3<-forecast::accuracy(gdp,midas3$fitted.values)

```
